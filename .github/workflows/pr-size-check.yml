name: PR Size Check

on:
    pull_request:
        types: [opened, synchronize]

permissions:
    contents: read
    pull-requests: write

jobs:
    size-check:
        name: Check PR size
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
                with:
                    fetch-depth: 0

            -   name: Get PR stats
                id: stats
                run: |
                    # Get the base and head commits
                    BASE_SHA=${{ github.event.pull_request.base.sha }}
                    HEAD_SHA=${{ github.event.pull_request.head.sha }}

                    # Get file changes
                    FILES_CHANGED=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA" | wc -l)
                    ADDITIONS=$(git diff --numstat "$BASE_SHA".."$HEAD_SHA" | awk '{sum+=$1} END {print sum}')
                    DELETIONS=$(git diff --numstat "$BASE_SHA".."$HEAD_SHA" | awk '{sum+=$2} END {print sum}')

                    echo "files_changed=$FILES_CHANGED" >> "$GITHUB_OUTPUT"
                    echo "additions=$ADDITIONS" >> "$GITHUB_OUTPUT"
                    echo "deletions=$DELETIONS" >> "$GITHUB_OUTPUT"

            -   name: Determine PR size
                id: size
                run: |
                    ADDITIONS="${{ steps.stats.outputs.additions }}"
                    DELETIONS="${{ steps.stats.outputs.deletions }}"
                    TOTAL=$((${ADDITIONS:-0} + ${DELETIONS:-0}))

                    if [ "$TOTAL" -lt 100 ]; then
                        echo "size=ğŸŸ¢ XS" >> "$GITHUB_OUTPUT"
                        echo "color=success" >> "$GITHUB_OUTPUT"
                    elif [ "$TOTAL" -lt 300 ]; then
                        echo "size=ğŸŸ¢ Small" >> "$GITHUB_OUTPUT"
                        echo "color=success" >> "$GITHUB_OUTPUT"
                    elif [ "$TOTAL" -lt 500 ]; then
                        echo "size=ğŸŸ¡ Medium" >> "$GITHUB_OUTPUT"
                        echo "color=warning" >> "$GITHUB_OUTPUT"
                    elif [ "$TOTAL" -lt 1000 ]; then
                        echo "size=ğŸŸ  Large" >> "$GITHUB_OUTPUT"
                        echo "color=warning" >> "$GITHUB_OUTPUT"
                    else
                        echo "size=ğŸ”´ XL" >> "$GITHUB_OUTPUT"
                        echo "color=important" >> "$GITHUB_OUTPUT"
                    fi

            -   name: Add sticky comment
                uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
                with:
                    header: pr-size-check
                    message: |
                        ## ğŸ“ PR Size: ${{ steps.size.outputs.size }}

                        **Changes:**
                        - ğŸ“ Files changed: ${{ steps.stats.outputs.files_changed }}
                        - â• Additions: ${{ steps.stats.outputs.additions }}
                        - â– Deletions: ${{ steps.stats.outputs.deletions }}

                        <details>
                        <summary>ğŸ’¡ Tips for managing PR size</summary>

                        - **XS/Small**: Easy to review âœ…
                        - **Medium**: Consider breaking down if possible
                        - **Large/XL**: Please split into smaller PRs for easier review

                        Smaller PRs are easier to review, test, and merge!
                        </details>

                        ---
                        *This comment updates automatically when the PR changes.*
