name: Test & Build

on:
    pull_request:
        branches:
            - master
    push:
        branches:
            - master

permissions:
    contents: read

jobs:
    # Detect which files changed
    changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: read
        outputs:
            src: ${{ steps.filter.outputs.src }}
            tests: ${{ steps.filter.outputs.tests }}
            config: ${{ steps.filter.outputs.config }}
            workflows: ${{ steps.filter.outputs.workflows }}
        steps:
            -   name: Checkout code
                uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            -   name: Check for file changes
                uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
                id: filter
                with:
                    filters: |
                        src:
                          - 'src/**'
                          - 'package.json'
                        tests:
                          - 'test/**'
                        config:
                          - 'tsconfig.json'
                          - 'biome.json'
                          - 'commitlint.config.js'
                        workflows:
                          - '.github/workflows/**'

    test-and-build:
        name: Test & Build
        runs-on: ubuntu-latest
        needs: changes
        # Run if source, tests, or config changed
        if: |
            needs.changes.outputs.src == 'true' ||
            needs.changes.outputs.tests == 'true' ||
            needs.changes.outputs.config == 'true' ||
            github.event_name == 'push'
        steps:
            -   name: Harden Runner
                uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
                with:
                    disable-sudo: true
                    egress-policy: audit

            -   name: Checkout code
                uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            -   name: Setup Node.js
                uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
                with:
                    node-version: "22"

            -   name: Install dependencies
                run: npm install --ignore-scripts

            -   name: Run type check
                run: npm run typecheck

            -   name: Run linter
                run: npm run lint

            -   name: Run unit tests
                run: npm run test:run

            -   name: Run build test
                run: npm run test:run test/build.test.ts
