name: Auto PR for Claude Branches

on:
    push:
        branches:
            - 'claude/**'

permissions:
    contents: read
    pull-requests: write

jobs:
    create-pr:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
                with:
                    fetch-depth: 0

            -   name: Check if PR already exists
                id: check-pr
                env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    BRANCH_NAME="${{ github.ref_name }}"
                    echo "Checking for existing PR from branch: $BRANCH_NAME"

                    # Check if PR exists for this branch
                    PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq 'length')

                    echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT

                    if [ "$PR_EXISTS" -gt 0 ]; then
                      PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
                      echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
                      echo "::notice::PR already exists: #$PR_NUMBER"
                    fi

            -   name: Extract session ID from branch name
                id: extract-info
                run: |
                    BRANCH_NAME="${{ github.ref_name }}"
                    # Extract session ID (everything after last hyphen)
                    SESSION_ID="${BRANCH_NAME##*-}"
                    echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT

                    # Create PR title from branch name
                    PR_TITLE="[Claude AI] ${BRANCH_NAME#claude/}"
                    echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

            -   name: Check for commits ahead of main
                id: check-commits
                run: |
                    # Count commits ahead of main
                    COMMIT_COUNT=$(git rev-list --count origin/main..HEAD)
                    echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

                    if [ "$COMMIT_COUNT" -eq 0 ]; then
                      echo "::warning::Branch has no commits ahead of main. Skipping PR creation."
                      echo "has_commits=false" >> $GITHUB_OUTPUT
                    else
                      echo "::notice::Branch has $COMMIT_COUNT commit(s) ahead of main"
                      echo "has_commits=true" >> $GITHUB_OUTPUT
                    fi

            -   name: Create Pull Request
                if: steps.check-pr.outputs.pr_exists == '0' && steps.check-commits.outputs.has_commits == 'true'
                env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    BRANCH_NAME="${{ github.ref_name }}"
                    PR_TITLE="${{ steps.extract-info.outputs.pr_title }}"
                    SESSION_ID="${{ steps.extract-info.outputs.session_id }}"

                    # Get commit messages for PR body
                    COMMITS=$(git log origin/main..HEAD --pretty=format:"- %s (%h)" | head -10)

                    # Create PR body
                    PR_BODY=$(cat << EOF
                    ## ü§ñ Automatyczny PR z Claude AI

                    **Branch:** \`$BRANCH_NAME\`
                    **Session ID:** \`$SESSION_ID\`
                    **Autor:** @${{ github.actor }}

                    ### Ostatnie commity:
                    $COMMITS

                    ---

                    Ten kod zosta≈Ç wygenerowany przy pomocy asystenta Claude AI.
                    Proszƒô o weryfikacjƒô przed merge'em.

                    > ‚ö†Ô∏è **Uwaga:** Sprawd≈∫ testy, linting i type checking przed zaakceptowaniem zmian.
                    EOF
                    )

                    # Create the PR
                    gh pr create \
                      --title "$PR_TITLE" \
                      --body "$PR_BODY" \
                      --base main \
                      --head "$BRANCH_NAME" \
                      --label "ai-generated" \
                      --label "automated-pr" \
                      --label "claude-code"

            -   name: PR Summary
                if: always()
                run: |
                    BRANCH_NAME="${{ github.ref_name }}"
                    COMMIT_COUNT="${{ steps.check-commits.outputs.commit_count }}"

                    if [ "${{ steps.check-commits.outputs.has_commits }}" == "false" ]; then
                      echo "::warning::No PR created - branch $BRANCH_NAME has no commits ahead of main"
                    elif [ "${{ steps.check-pr.outputs.pr_exists }}" -gt 0 ]; then
                      echo "::notice::PR #${{ steps.check-pr.outputs.pr_number }} already exists for branch $BRANCH_NAME ($COMMIT_COUNT commits)"
                    else
                      echo "::notice::New PR created for branch $BRANCH_NAME ($COMMIT_COUNT commits)"
                    fi
