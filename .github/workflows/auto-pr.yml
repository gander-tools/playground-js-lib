name: Auto PR for Claude Branches

on:
    push:
        branches:
            - 'claude/**'

permissions:
    contents: read
    pull-requests: write

jobs:
    create-pr:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
                with:
                    fetch-depth: 0

            -   name: Check if PR already exists
                id: check-pr
                env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    BRANCH_NAME="${{ github.ref_name }}"
                    echo "Checking for existing PR from branch: $BRANCH_NAME"

                    # Check if PR exists for this branch
                    PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq 'length')

                    echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT

                    if [ "$PR_EXISTS" -gt 0 ]; then
                      PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
                      echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
                      echo "::notice::PR already exists: #$PR_NUMBER"
                    fi

            -   name: Extract PR title from first commit
                id: extract-info
                run: |
                    # Get title from first commit on branch
                    PR_TITLE=$(git log origin/master..HEAD --pretty=format:"%s" --reverse | head -1)
                    echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

            -   name: Create Pull Request
                if: steps.check-pr.outputs.pr_exists == '0'
                env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    BRANCH_NAME="${{ github.ref_name }}"
                    PR_TITLE="${{ steps.extract-info.outputs.pr_title }}"

                    # Get commit messages for PR body
                    COMMITS=$(git log origin/master..HEAD --pretty=format:"- %s (%h)" | head -10)

                    # Create PR body
                    PR_BODY=$(cat << EOF
                    ### Recent Commits:
                    $COMMITS

                    ---

                    This code was generated with the assistance of Claude AI.
                    EOF
                    )

                    # Create the PR
                    gh pr create \
                      --title "$PR_TITLE" \
                      --body "$PR_BODY" \
                      --base master \
                      --head "$BRANCH_NAME" \
                      --label "ai-generated" \
                      --label "claude-code"

            -   name: PR Summary
                if: always()
                run: |
                    BRANCH_NAME="${{ github.ref_name }}"

                    if [ "${{ steps.check-pr.outputs.pr_exists }}" -gt 0 ]; then
                      echo "::notice::PR #${{ steps.check-pr.outputs.pr_number }} already exists for branch $BRANCH_NAME"
                    else
                      echo "::notice::New PR created for branch $BRANCH_NAME"
                    fi
