name: Trivy Security Scan

on:
    push:
        branches:
            - master
    pull_request:
    schedule:
        # Run weekly on Tuesdays at 00:00 UTC
        -   cron: '0 0 * * 2'

permissions:
    contents: read

jobs:
    trivy-scan:
        name: Trivy Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            -   name: Harden Runner
                uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
                with:
                    disable-sudo: true
                    egress-policy: audit

            -   name: Checkout code
                uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

            -   name: Run Trivy vulnerability scanner
                uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # v0.28.0
                with:
                    scan-type: 'fs'
                    scan-ref: '.'
                    format: 'sarif'
                    output: 'trivy-results.sarif'
                    severity: 'CRITICAL,HIGH,MEDIUM'

            -   name: Upload Trivy results to GitHub Security
                uses: github/codeql-action/upload-sarif@d3ced5c96c16c4332e2a61eb6f3649d6f1b20bb8 # v3.31.5
                with:
                    sarif_file: 'trivy-results.sarif'
